using System.Numerics;
using Content.Client.Message;
using Content.Client.UserInterface.Controls;
using Content.Shared._WL.CharacterInformation;
using Content.Shared._WL.Preferences;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;

namespace Content.Client._WL.CharacterInformation;

[GenerateTypedNameReferences]
public sealed partial class CharacterInformationWindow : FancyWindow
{
    private float _accumulatedTime;

    public CharacterInformationWindow()
    {
        RobustXamlLoader.Load(this);
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        _accumulatedTime += args.DeltaSeconds;
        CharSprite.OverrideDirection = (Direction) ((int) _accumulatedTime % 4 * 2);
    }

    public void UpdateState(CharacterInformationBuiState state)
    {
        CharSprite.SetEntity(state.Uid);
        Name.SetMarkup($"[bold]{state.CharacterName}[/bold]");

        if (state.ErpStatus != null)
        {
            var color = (state.ErpStatus switch
            {
                ErpStatus.Ask or ErpStatus.CheckOOC => Color.Yellow,
                ErpStatus.No => Color.Red,
                >= ErpStatus.Yes => Color.Green,
                _ => Color.Gray
            }).ToHex();

            var text = Loc.GetString(state.ErpStatus switch
            {
                ErpStatus.Ask => "character-information-ui-erp-status-ask",
                ErpStatus.CheckOOC => "character-information-ui-erp-status-ooc",
                ErpStatus.No => "character-information-ui-erp-status-no",
                ErpStatus.Yes => "character-information-ui-erp-status-yes",
                _ => "character-information-ui-erp-status-unknown"
            });

            // ErpStatusText.SetMarkup($"[color={color}]{text}[/color]");
        }

        if (!string.IsNullOrEmpty(state.FlavorText))
        {
            FlavorText.SetMessage(state.FlavorText);
            FlavorTextLabel.Visible = true;
        }
        if (!string.IsNullOrEmpty(state.OocText))
        {
            OocText.SetMessage(state.OocText);
            OocTextLabel.Visible = true;
        }

        if (string.IsNullOrEmpty(state.FlavorText) && string.IsNullOrEmpty(state.OocText))
        {
            Separator.Visible = false;
            TextScroll.Visible = false;
            RootWindow.MinSize = new Vector2(280, 400);
            RootWindow.SetSize = new Vector2(280, 400);
        }
        else
        {
            Separator.Visible = true;
            TextScroll.Visible = true;
            RootWindow.MinSize = new Vector2(700, 400);
            RootWindow.SetSize = new Vector2(700, 400);
        }
    }
}
